# 模型选择优化说明

## 🎯 问题

在自动模式下，千问模型可能被选中，但它对我们的复杂System Prompt（特别是工具调用格式）支持不够好，导致MCP调用失败。

---

## 🔍 原因分析

### 原来的自动选择逻辑
```javascript
// 基于延迟选择最快的模型
return availableModels.reduce((best, current) => {
  return current.stats.avgLatency < best.stats.avgLatency ? current : best;
});
```

**问题：**
- 千问响应可能更快，但对复杂Prompt支持不好
- 导致工具调用格式识别失败
- MCP无法正常触发

---

## ✅ 优化方案

### 新的自动选择逻辑
```javascript
// 优先使用DeepSeek（对复杂Prompt支持更好）
if (deepseek && 成功率可接受) {
  return deepseek;  // 优先
}

if (qwen && 成功率可接受) {
  return qwen;  // 备用
}
```

**改进：**
- ✅ 优先使用DeepSeek（对复杂Prompt支持更好）
- ✅ 千问作为备用（当DeepSeek失败率高时）
- ✅ 保证MCP调用的准确性

---

## 📊 模型对比

| 模型 | 复杂Prompt支持 | 工具调用 | 响应速度 | 推荐用途 |
|------|---------------|---------|---------|---------|
| DeepSeek | ⭐⭐⭐⭐⭐ | ✅ 优秀 | 中等 | 主力模型 |
| 千问 | ⭐⭐⭐ | ⚠️ 一般 | 快 | 备用模型 |

---

## 🎯 使用建议

### 1. 自动模式（推荐）
```javascript
// 前端选择"自动切换"
// 系统会优先使用DeepSeek
```

**优点：**
- 自动选择最合适的模型
- DeepSeek优先，保证准确性
- 千问备用，保证可用性

---

### 2. 手动指定DeepSeek
```javascript
// 前端选择"DeepSeek"
// 强制使用DeepSeek
```

**优点：**
- 保证最佳的Prompt支持
- 保证MCP调用准确性

**缺点：**
- 如果DeepSeek故障，无法自动切换

---

### 3. 手动指定千问（不推荐）
```javascript
// 前端选择"千问"
// 强制使用千问
```

**问题：**
- 对复杂Prompt支持不够好
- MCP调用可能失败
- 工具调用格式识别不准确

**建议：** 仅在DeepSeek不可用时使用

---

## 🔧 配置说明

### 前端模型选择器
```html
<select id="modelSelect">
  <option value="auto">自动切换</option>      <!-- 推荐：优先DeepSeek -->
  <option value="deepseek">DeepSeek</option>  <!-- 手动指定 -->
  <option value="qwen">千问</option>          <!-- 不推荐 -->
</select>
```

### 自动模式行为
- ✅ 优先使用DeepSeek
- ✅ DeepSeek失败率>30%时切换到千问
- ✅ 保证系统可用性

---

## 📝 测试验证

### 测试1：自动模式
```bash
# 启动服务
npm start

# 在浏览器中选择"自动切换"
# 测试MCP调用
```

**预期：**
- 使用DeepSeek模型
- MCP调用正常
- 工具调用格式正确

---

### 测试2：手动指定DeepSeek
```bash
# 在浏览器中选择"DeepSeek"
# 测试MCP调用
```

**预期：**
- 强制使用DeepSeek
- MCP调用正常

---

### 测试3：手动指定千问
```bash
# 在浏览器中选择"千问"
# 测试MCP调用
```

**预期：**
- 使用千问模型
- MCP调用可能失败（已知问题）

---

## 🚀 重启服务

```bash
# 使用PM2
pm2 restart crypto-ai

# 或手动重启
npm start
```

---

## 📊 监控建议

### 查看模型统计
```bash
curl http://localhost:3000/api/models
```

**返回示例：**
```json
{
  "available": ["auto", "deepseek", "qwen"],
  "stats": {
    "currentMode": "auto",
    "models": [
      {
        "name": "deepseek",
        "calls": 100,
        "errors": 5,
        "avgLatency": 1200,
        "successRate": "95.00%"
      },
      {
        "name": "qwen",
        "calls": 20,
        "errors": 8,
        "successRate": "60.00%"
      }
    ]
  }
}
```

---

## 🎯 总结

### 优化前
- ❌ 基于延迟选择模型
- ❌ 千问可能被优先选中
- ❌ MCP调用失败

### 优化后
- ✅ 优先使用DeepSeek
- ✅ 千问作为备用
- ✅ MCP调用准确

### 建议
- 🌟 使用"自动切换"模式（已优化）
- 🌟 或手动选择"DeepSeek"
- ⚠️ 避免手动选择"千问"

---

**最后更新：** 2026-01-23
