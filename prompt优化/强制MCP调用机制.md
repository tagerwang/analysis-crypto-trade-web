# 强制MCP调用机制

## 问题背景

用户反馈：当问"btc现在可以开空吗？"时，AI没有调用MCP查询实时价格，而是给出了错误的价格（$61,680，实际应该更高）。

## 根本原因

之前的实现依赖AI模型主动生成 `[TOOL_CALL:...]` 指令来触发MCP调用。但AI模型可能：
1. 忘记调用工具
2. 使用记忆中的旧价格
3. 猜测价格

## 解决方案

### 1. 服务端强制检测

在 `ChatService.js` 中添加 `detectForcedMCPCall()` 方法：

```javascript
detectForcedMCPCall(userMessage) {
  // 检测是否提到单个币种
  // 检测是否是价格/交易相关问题
  // 返回 { symbol, reason } 或 null
}
```

**检测规则：**
- 只提到**单个币种**（避免"BTC和ETH哪个好"这种对比问题）
- 包含价格/交易关键词（价格、开多、开空、走势等）
- 支持中英文币种名称识别

### 2. 动态注入强制指令

当检测到单个币种查询时，在系统提示词中注入：

```xml
<forced_mcp_call>
⚠️ 强制要求：用户询问了BTC的单个币种价格/交易查询
你必须立即调用MCP工具获取实时数据，不要使用任何记忆中的价格！

必须调用：
1. [TOOL_CALL:binance:comprehensive_analysis:{"symbol":"BTC"}]
2. [TOOL_CALL:binance:get_top_gainers_losers:{"limit":20}]

禁止：
- 不要使用任何记忆中的价格数据
- 不要猜测价格
- 不要说"根据最新数据"然后给出错误价格
- 必须等待工具返回实际数据后再回答
</forced_mcp_call>
```

### 3. 支持的币种

**主流币：**
- BTC/比特币/Bitcoin/大饼
- ETH/以太坊/Ethereum/姨太/以太
- BNB/币安币/币安/Binance Coin
- XRP/瑞波币/瑞波/Ripple
- SOL/索拉纳/Solana
- ADA/艾达币/Cardano/卡尔达诺

**热门山寨币：**
- DOGE/狗狗币/狗币/Dogecoin/狗子
- SHIB/柴犬币/柴犬/Shiba
- PEPE/佩佩/青蛙币
- MATIC/Polygon/马蹄/马蹄币
- AVAX/雪崩/Avalanche
- DOT/波卡/Polkadot
- LINK/Chainlink/链克
- UNI/Uniswap/优你
- ARB/Arbitrum/阿比
- OP/Optimism

## 测试方法

运行测试脚本：

```bash
./test-forced-mcp.sh
```

**检查要点：**
1. 服务器日志中是否出现 "🎯 检测到单个币种查询"
2. 是否调用了MCP工具
3. 返回的价格是否准确
4. 是否包含大盘分析

## 预期效果

**用户问：** "btc现在可以开空吗？"

**系统行为：**
1. ✅ 检测到单个币种查询（BTC）
2. ✅ 强制注入MCP调用指令
3. ✅ AI必须调用 `comprehensive_analysis` 和 `get_top_gainers_losers`
4. ✅ 基于实时数据给出建议
5. ✅ 价格准确，包含大盘分析

**AI回复示例：**
```
【大盘】涨多跌少，65%币种上涨，做多环境

BTC现在$67,234
市值$1.3T，流动性优秀

技术面（小时级别）：
- 小时MACD金叉，多头动增强
- 小时RSI 53.19，中性偏强
- 价格在小时布林带上轨附近，有压力
- 看涨概率70.1%

不建议开空

理由：
1. 大盘涨多跌少，做空环境不利
2. 小时级别技术面偏多，MACD金叉
3. 价格在关键支撑$61,500上方，趋势向上

如果真想操作：
- 等反弹到$62,000-62,200阻力区再考虑轻仓试空
- 止损：$62,500
- 目标：$61,000
- 仓位：<10%（逆势操作风险高）
```

## 优势

1. **100%准确率**：单个币种查询必定触发MCP
2. **无需依赖AI**：不依赖AI模型的"记忆"
3. **支持中文**：识别"比特币"、"狗狗币"等中文名称
4. **避免误触发**：只在单个币种+价格/交易问题时触发
5. **日志可追踪**：控制台输出 "🎯 检测到单个币种查询"

## 注意事项

1. **只触发单个币种**：避免"BTC和ETH哪个好"这种对比问题
2. **必须包含价格/交易关键词**：避免"BTC是什么"这种科普问题
3. **不影响其他场景**：多币种对比、科普问题等仍由AI自主判断

## 后续优化

如果仍有遗漏，可以：
1. 扩展币种识别列表
2. 增加更多价格/交易关键词
3. 添加更多日志输出，方便调试
