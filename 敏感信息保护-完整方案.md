# 🔒 敏感信息保护 - 完整方案

**配置完成时间**: 2026-02-15  
**状态**: ✅ 已配置完成，可立即使用

---

## 🎯 问题解决

### 你遇到的问题

1. ✅ .env 文件包含明文敏感信息（域名、IP、密码）
2. ✅ 文档中泄露了服务器配置
3. ✅ 每次完成需求都要手动脱敏
4. ✅ 希望 AI 自动记住并遵守安全规范

### 解决方案

通过 **Cursor Rules** + **脚本工具** + **配置模板** 三管齐下，实现：

- 🤖 **AI 自动遵守**: AI 会自动使用环境变量和占位符
- 🔧 **一键脱敏**: 批量处理现有文档
- 📋 **配置模板**: 新项目快速复用
- 🔍 **自动验证**: 检测潜在泄露

---

## 📦 已创建的文件

### 1. 核心配置

```
.cursor/rules/
  └── security-and-privacy.mdc    # AI 安全规则（自动生效）
  └── README.md                    # 规则说明文档

.env.example                       # 脱敏的配置模板
README-SECURITY.md                 # 安全使用指南
```

### 2. 工具脚本

```
scripts/
  ├── sanitize-docs.sh            # 文档批量脱敏工具
  └── verify-security.sh          # 安全配置验证工具
```

---

## 🚀 快速开始

### 第一步：验证当前配置

```bash
cd /Users/wangtao/wave/exercise/analysis-crypto-trade-web

# 运行安全验证
./scripts/verify-security.sh
```

**验证结果**：
```
✓ 通过: 5
⚠ 警告: 1 (发现一些文档包含明文敏感信息)
```

### 第二步：脱敏现有文档

```bash
# 脱敏所有 Markdown 文档
./scripts/sanitize-docs.sh "*.md"

# 脱敏所有 Shell 脚本
./scripts/sanitize-docs.sh "*.sh"

# 脱敏特定目录
./scripts/sanitize-docs.sh "models优化/*.sh"
```

**脚本会自动**：
- 🔍 扫描文件中的敏感信息
- 🔄 替换为环境变量格式（如 `${SERVER_IP}`）
- 📦 创建备份文件（`.bak` 后缀）
- ✅ 报告处理结果

### 第三步：重新验证

```bash
# 再次验证，确保没有泄露
./scripts/verify-security.sh
```

**期望结果**：
```
✓ 通过: 6
✗ 失败: 0
⚠ 警告: 0
🎉 完美！所有检查都通过了！
```

---

## 🤖 AI 自动保护

配置完成后，AI 会**自动遵守**以下规范：

### 编写代码时

```javascript
// ❌ AI 不会再这样写
const apiKey = 'sk-013f4461081b4d74a765b3cc3fa47b18';

// ✅ AI 会自动这样写
const apiKey = process.env.DEEPSEEK_API_KEY;
```

### 创建脚本时

```bash
# ❌ AI 不会再这样写
ssh root@45.32.114.70

# ✅ AI 会自动这样写
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs)
fi
SERVER_IP="${SERVER_IP:-YOUR_SERVER_IP}"
ssh $SERVER_USER@$SERVER_IP
```

### 编写文档时

```markdown
❌ AI 不会再这样写：
部署地址: https://trade-your.com
服务器: root@45.32.114.70

✅ AI 会自动这样写：
部署地址: https://${BASE_DOMAIN}
服务器: ${SERVER_USER}@${SERVER_IP}
```

---

## 📋 日常使用

### 提交代码前

```bash
# 1. 验证安全性
./scripts/verify-security.sh

# 2. 查看改动
git diff

# 3. 确认无敏感信息后提交
git add .
git commit -m "你的提交信息"
```

### 新建文档或脚本

AI 会自动：
- ✅ 使用 `${变量名}` 格式
- ✅ 从 `.env` 读取配置
- ✅ 提供脱敏的示例

你不需要：
- ❌ 手动检查敏感信息
- ❌ 提交后再回来脱敏
- ❌ 担心泄露风险

### 复制代码到其他项目

```bash
# 1. 复制规则配置
cp -r .cursor/rules/ /path/to/new-project/

# 2. 复制工具脚本
cp -r scripts/ /path/to/new-project/

# 3. 复制配置模板
cp .env.example /path/to/new-project/

# 4. 复制安全指南
cp README-SECURITY.md /path/to/new-project/
```

---

## 🔍 配置原理

### 1. Cursor Rules 工作机制

文件位置: `.cursor/rules/security-and-privacy.mdc`

```yaml
---
description: 敏感信息保护和文档规范
alwaysApply: true  # 在所有对话中自动生效
---
```

**生效时机**：
- 每次与 AI 对话时自动加载
- 不需要手动 @规则
- 不需要重启 Cursor
- 全局生效，覆盖所有文件类型

**规则内容**：
- 📝 明确的 ✅ 正确 / ❌ 错误 示例
- 📋 敏感信息类型清单
- 🛡️ 安全编码规范
- 💡 最佳实践指南

### 2. 脱敏脚本工作原理

**sanitize-docs.sh**：

```bash
# 1. 从 .env 读取真实值
source .env

# 2. 定义替换映射
replacements=(
  ["$SERVER_IP"]="\${SERVER_IP}"
  ["$DEEPSEEK_API_KEY"]="sk-****"
)

# 3. 批量替换文件内容
sed -i "s|$original|$replacement|g" "$file"
```

**verify-security.sh**：

```bash
# 1. 检查必要文件是否存在
[ -f .env.example ]
[ -f .cursor/rules/security-and-privacy.mdc ]

# 2. 扫描潜在泄露
git grep "$SERVER_IP" -- '*.md' '*.sh'

# 3. 验证 .env 未被 Git 跟踪
git ls-files --error-unmatch .env
```

---

## 🎓 最佳实践

### 1. 团队协作

**新成员入职**：

```bash
# 1. 克隆仓库
git clone <repo-url>

# 2. 复制配置模板
cp .env.example .env

# 3. 填写真实值（向团队管理员索取）
nano .env

# 4. 验证配置
./scripts/verify-security.sh
```

**代码审查清单**：

```markdown
## 安全检查

- [ ] 运行 `./scripts/verify-security.sh` 通过
- [ ] 代码中无硬编码的 IP、密钥
- [ ] 文档中使用环境变量占位符
- [ ] `.env` 未被提交
```

### 2. CI/CD 集成

在 GitHub Actions 中添加：

```yaml
- name: Security Check
  run: |
    ./scripts/verify-security.sh
    if [ $? -ne 0 ]; then
      echo "❌ 发现敏感信息泄露！"
      exit 1
    fi
```

### 3. 定期审计

```bash
# 每周运行一次
./scripts/verify-security.sh

# 扫描 Git 历史
git log --all --source -S "API_KEY" --pretty=format:"%h %an %s"
```

---

## 🚨 应急处理

### 场景 1: 不小心提交了 .env

```bash
# 立即从 Git 移除（保留本地文件）
git rm --cached .env
git commit -m "移除敏感配置文件"
git push

# 轮换所有凭证
# - 重新生成 API 密钥
# - 更改服务器密码
```

### 场景 2: 文档中泄露了敏感信息

```bash
# 方法 1: 使用脱敏脚本
./scripts/sanitize-docs.sh "*.md"
git add .
git commit -m "脱敏文档中的敏感信息"

# 方法 2: 手动修改
# 编辑文件，替换为环境变量格式
```

### 场景 3: Git 历史中有泄露

```bash
# 使用 git-filter-repo 清理历史
git filter-repo --replace-text <(echo "45.32.114.70==>YOUR_SERVER_IP")

# 强制推送（危险！需团队同意）
git push --force-with-lease
```

---

## 📊 效果对比

### 修复前 ❌

```markdown
**部署地址**: https://trade-your.com
**服务器**: root@45.32.114.70
**API Key**: sk-013f4461081b4d74a765b3cc3fa47b18

ssh root@45.32.114.70 'pm2 restart app'
```

### 修复后 ✅

```markdown
**部署地址**: https://${BASE_DOMAIN}
**服务器**: ${SERVER_USER}@${SERVER_IP}
**API Key**: ${DEEPSEEK_API_KEY}

ssh $SERVER_USER@$SERVER_IP 'pm2 restart app'
```

---

## 🎯 核心优势

| 特性 | 修复前 | 修复后 |
|------|--------|--------|
| **AI 自动遵守** | ❌ 需要手动提醒 | ✅ 自动生效 |
| **文档脱敏** | ❌ 手动查找替换 | ✅ 一键批量处理 |
| **泄露检测** | ❌ 肉眼检查 | ✅ 自动扫描 |
| **团队协作** | ❌ 容易忘记 | ✅ 规则共享 |
| **新项目复用** | ❌ 从头配置 | ✅ 复制即用 |

---

## 💡 常见问题

### Q: 规则会影响 AI 的正常功能吗？

**A**: 不会。规则只是告诉 AI 如何处理敏感信息，不影响其他功能。AI 仍然可以：
- 编写代码和脚本
- 回答技术问题
- 调试和优化
- 生成文档

### Q: 如果我需要在文档中展示真实配置怎么办？

**A**: 可以在特定场景中使用代码块标注：

```markdown
<!-- 仅供内部参考，不要提交 -->
```bash
# 生产环境配置（敏感）
SERVER_IP=45.32.114.70
```
```

但**不建议**这样做。更好的方式是：
- 使用私有 Wiki 或文档系统
- 使用密码管理器（如 1Password、Bitwarden）
- 使用专用的配置管理工具

### Q: 脱敏脚本会修改哪些文件？

**A**: 默认情况下：
- `*.md` - Markdown 文档
- `*.sh` - Shell 脚本

你可以通过参数指定：
```bash
./scripts/sanitize-docs.sh "*.md"           # 只处理 Markdown
./scripts/sanitize-docs.sh "deploy*.sh"    # 只处理部署脚本
./scripts/sanitize-docs.sh "**/*.md"       # 包括子目录
```

### Q: 如何在其他项目中使用这套方案？

**A**: 非常简单：

```bash
# 1. 复制关键文件到新项目
cp -r .cursor/rules/ /path/to/new-project/
cp scripts/sanitize-docs.sh /path/to/new-project/scripts/
cp scripts/verify-security.sh /path/to/new-project/scripts/
cp .env.example /path/to/new-project/

# 2. 在新项目中创建 .env
cd /path/to/new-project
cp .env.example .env
nano .env  # 填写真实值

# 3. 验证配置
./scripts/verify-security.sh
```

---

## ✅ 完成检查清单

现在你可以：

- [x] ✅ AI 会自动使用环境变量和占位符
- [x] ✅ 运行 `./scripts/sanitize-docs.sh` 批量脱敏文档
- [x] ✅ 运行 `./scripts/verify-security.sh` 检测泄露
- [x] ✅ 使用 `.env.example` 作为配置模板
- [x] ✅ 复制规则到其他项目使用
- [x] ✅ 不再需要手动检查和脱敏

---

## 🔗 相关文档

- [README-SECURITY.md](./README-SECURITY.md) - 详细的安全指南
- [.cursor/rules/README.md](./.cursor/rules/README.md) - 规则管理说明
- [.env.example](./.env.example) - 配置模板

---

**配置完成！现在你可以放心地让 AI 处理项目，不用担心敏感信息泄露了！** 🎉🔒

---

**最后更新**: 2026-02-15  
**维护者**: AI Assistant  
**版本**: v1.0
